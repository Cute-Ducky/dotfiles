---
version: '3'

dotenv: ['misc/.env']

tasks:
  apply:
    cmds: 
      - task: prepare
      - echo "applying $CONF ..."
      - ./misc/root nixos-rebuild --flake .#$CONF -p $CONF --impure --install-bootloader switch
      - task: rm-prepare

  env:
    cmds:
      - echo "$CONF"
      - echo "$USER"
    silent: true

  prepare:
    cmds:
      - task: cp-hardware
      - task: hostid
      - task: tailscale
 
  rm-prepare:
    cmds:
      - task: rm-hostid
      - task: rm-tailscale

  vm:
    cmds: 
      - task: prepare
      - echo "building VM of $CONF ..."
      - ./misc/root nixos-rebuild --flake .#$CONF -p $CONF build-vm
      - task: rm-prepare

  rm:
    cmds:
      - ./misc/root nix-collect-garbage --delete-older-than 14d

  hostid:
    cmds:
      - sed -i "s/12355671/$(./misc/host-id)/g" system/configuration.nix

  rm-hostid:
    cmds:
      - sed -i "s/$(./misc/host-id)/12355671/g" system/configuration.nix

  cp-hardware:
    cmds:
      #- cp -f /etc/nixos/hardware-configuration.nix system
      - ./misc/cp-hardware

  auto-snapshot:
    cmds:
      - ./misc/root zfs set com.sun:auto-snapshot=true NIXROOT/home

  update:
    cmds:
      - nix flake update
  
  cupdate:
    cmds:
      - task: update
      - git add flake.lock
      - git commit -m "update flake.lock"

  test:
    cmds:
      - task: apply
      - nix flake check

  push:
    cmds:
      - task: test
      - git push


  apply-user:
    cmds:
      - nix build .#homeManagerConfigurations.$USER.activationPackage
      - ./result/activate

  tailscale:
    cmds:
      #- sed -i "s/#.\/system\/key.nix/.\/system\/key.nix/g" flake.nix
      - ./misc/get-key add


  rm-tailscale:
    cmds:
      - ./misc/get-key rm

  jellyfin:
    cmds:
      - ./misc/root mkdir /jellyfin
      - ./misc/root chown -R jellyfin:jellyfin /jellyfin

  pupdate:
    cmds:
      - git pull
      - task: apply
      - task: apply-user
