#!/bin/sh
# FIXME indicator for using a script in misc

git_files="
system/key.nix
system/nextcloud.nix
system/configuration.nix
system/config-nixops.nix
system/hardware-configuration.nix"

log_level=2
log() {
   # Usage: log message log_level
   # Example: log "hello" 1
   if [ "$log_level" -ge "$2" ]
   then
      if [ "$2" -eq 1 ]
      then
         printf '\033[1m >> %s \n\033[m' "$1" 
      else
         printf '%s \n' "$1"
      fi
   fi
}

fatal() {
   # Usage: fatal message
   printf '\033[1m >> %s \n\033[m' "$1" 
   exit 1
}

root() {
   if ! command -v sudo > /dev/null
   then
      doas "$@"
   else
      sudo "$@"
   fi
}

# Tasks:
remove_from_git() {
   log "remove_from_git" 1
   for git_file in $git_files; do
      git rm --cached "$git_file" > /dev/null
      log "removed $git_file from git" 2
   done
}

add_to_git() {
   log "add_to_git" 1
   for git_file in $git_files; do
      #:> "$git_file" # like rm $git_file && touch $git_file
      touch "$git_file"
      git add -f "$git_file"
      log "added $git_file to git" 2
   done
   trap remove_from_git EXIT # execute remove from git before exiting the script
}

prepare() {
   log "prepare" 1
   misc/install nextcloud # FIXME
   misc/cp-hardware
   misc/host-id
   misc/get-key add
   add_to_git # add files needed by flake to git
}

apply() {
   log "apply" 1
   if [ -s misc/.env ]
   then
      . misc/.env
   else
      fatal "no .env file"
   fi
   prepare
   log "rebuilding nixos" 2
   root nixos-rebuild --flake ".#$CONF" -p "$CONF" --impure --install-bootloader switch
}
apply
#add_to_git
